
<!DOCTYPE html>
<html lang="pt-BR">
<head>

  <meta charset="UTF-8" />
  <link rel="icon" href="logo.ico">
  <title>Bosco Jones Wallet - Pix, Saldo & Saque</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background-color: #0d1117;
      color: #c9d1d9;
      font-family: Arial, sans-serif;
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
    }
    h1, h2 {
      color: #58a6ff;
      text-align: center;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 0.5rem;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
    }
    button {
      background-color: #4caf50;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #357a38;
    }
    .btn-danger {
      background-color: #f44336;
    }
    .btn-danger:hover {
      background-color: #d32f2f;
    }
    #qrCodeCanvas {
      display: block;
      margin: 1rem auto;
    }
    #infoPix {
      text-align: center;
      margin-top: 0.5rem;
      color: #58a6ff;
    }
    #userArea {
      margin-top: 2rem;
    }
    .message {
      margin: 1rem 0;
      padding: 0.7rem;
      border-radius: 4px;
      background-color: #222;
      color: #0f0;
      text-align: center;
    }
    .error {
      background-color: #800000;
      color: #f88;
    }
    label {
      margin-top: 1rem;
      display: block;
      font-weight: bold;
      color: #58a6ff;
    }
  </style>
</head>
<body>

<h1>Bosco Jones Wallet</h1>

<div id="authArea">
  <h2>Login / Registro</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Senha" />
  <button id="btnRegister">Registrar</button>
  <button id="btnLogin">Entrar</button>
  <p id="authMessage"></p>
</div>

<div id="userArea" style="display:none;">
  <h2>Olá, <span id="userEmail"></span></h2>
  <p><strong>Saldo atual:</strong> R$ <span id="userSaldo">0,00</span></p>

  <label for="paymentAmount">Valor para pagar (R$):</label>
  <input type="number" id="paymentAmount" min="0.01" step="0.01" placeholder="Ex: 100" />
  <button id="btnGeneratePix">Gerar QR Code Pix + 5% taxa</button>

  <canvas id="qrCodeCanvas"></canvas>
  <p id="infoPix"></p>

  <label for="withdrawAmount">Valor para saque (R$):</label>
  <input type="number" id="withdrawAmount" min="0.01" step="0.01" placeholder="Ex: 50" />
  <button id="btnWithdraw" class="btn-danger">Solicitar Saque</button>

  <button id="btnLogout" style="margin-top: 2rem; background-color:#f44336;">Sair</button>

  <p id="actionMessage"></p>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QRCode.js -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script>
  // Configuração do Firebase (sua config)
  const firebaseConfig = {
    apiKey: "AIzaSyDzfZvQi-oaOUWPgSOu8BtTINa_LO2ZoLc",
    authDomain: "bosco-jones-wallet.firebaseapp.com",
    projectId: "bosco-jones-wallet",
    storageBucket: "bosco-jones-wallet.firebasestorage.app",
    messagingSenderId: "1829673164",
    appId: "1:1829673164:web:37c947c8aafe1af72a8a69",
    measurementId: "G-6SZH0MHRGE"
  };

  // Inicializa Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Elementos DOM
  const authArea = document.getElementById('authArea');
  const userArea = document.getElementById('userArea');
  const userEmailSpan = document.getElementById('userEmail');
  const userSaldoSpan = document.getElementById('userSaldo');
  const authMessage = document.getElementById('authMessage');
  const actionMessage = document.getElementById('actionMessage');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const paymentAmountInput = document.getElementById('paymentAmount');
  const withdrawAmountInput = document.getElementById('withdrawAmount');
  const btnRegister = document.getElementById('btnRegister');
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const btnGeneratePix = document.getElementById('btnGeneratePix');
  const btnWithdraw = document.getElementById('btnWithdraw');
  const qrCodeCanvas = document.getElementById('qrCodeCanvas');
  const infoPix = document.getElementById('infoPix');

  // Pix chave fixa (sua conta fundo)
  const pixKeyFundo = "48761013889";

  // Função para formatar valor em real para string Pix (padrão: 100.00 -> "100.00")
  function formatBRLtoPix(valor) {
    return valor.toFixed(2);
  }

  // Função para gerar payload Pix (simplificado, sem CRC final para demo)
  // Melhor usar biblioteca oficial no backend para produção!
  function generatePixPayload(key, valor, txid) {
    // Campos fixos do payload Pix
    // Referência: https://www.bcb.gov.br/estabilidadefinanceira/pix
    const payloadFormatIndicator = "00" + "02"; // ID 00, length 02, value 02
    const merchantAccountInfo = "26" + String(key.length + 4).padStart(2, '0') + "0014BR.GOV.BCB.PIX" + "01" + String(key.length).padStart(2, '0') + key;
    const merchantCategoryCode = "52" + "04" + "0000"; // sem categoria
    const transactionCurrency = "53" + "03" + "986"; // BRL
    const transactionAmount = "54" + String(valor.length).padStart(2, '0') + valor;
    const txidField = "58" + "02" + "BR";
    const additionalDataField = "62" + String(4 + txid.length).toString().padStart(2, '0') + "05" + String(txid.length).padStart(2, '0') + txid;

    // Monta payload (sem CRC)
    const payloadNoCRC = payloadFormatIndicator + merchantAccountInfo + merchantCategoryCode + transactionCurrency + transactionAmount + txidField + additionalDataField;

    // Calcula CRC16-CCITT para o payload (com "6304" + 4 espaços)
    const crc = crc16(payloadNoCRC + "6304");

    // Formata CRC em hex maiúsculo
    const crcHex = crc.toString(16).toUpperCase().padStart(4, '0');

    // Payload final
    return payloadNoCRC + "63" + "04" + crcHex;
  }

  // Função CRC16-CCITT (XModem)
  // Fonte: https://gist.github.com/walletmix/7db1d5b1e207ee7151e56a0a81949bc9
  function crc16(str) {
    let crc = 0xFFFF;
    for (let i = 0; i < str.length; i++) {
      crc ^= str.charCodeAt(i) << 8;
      for (let j = 0; j < 8; j++) {
        if ((crc & 0x8000) !== 0) {
          crc = (crc << 1) ^ 0x1021;
        } else {
          crc <<= 1;
        }
        crc &= 0xFFFF;
      }
    }
    return crc;
  }

  // Cria usuário novo no Firestore com saldo zero
  async function createUserDoc(uid, email) {
    const userRef = db.collection('users').doc(uid);
    const doc = await userRef.get();
    if (!doc.exists) {
      await userRef.set({
        email,
        saldo: 0,
      });
    }
  }

  // Atualiza saldo do usuário
  async function updateSaldo(uid, valor) {
    const userRef = db.collection('users').doc(uid);
    await db.runTransaction(async (transaction) => {
      const doc = await transaction.get(userRef);
      if (!doc.exists) throw "Usuário não encontrado";
      const saldoAtual = doc.data().saldo || 0;
      const novoSaldo = saldoAtual + valor;
      if (novoSaldo < 0) throw "Saldo insuficiente";
      transaction.update(userRef, { saldo: novoSaldo });
      return novoSaldo;
    });
  }

  // Pega saldo do usuário
  async function getSaldo(uid) {
    const userRef = db.collection('users').doc(uid);
    const doc = await userRef.get();
    if (doc.exists) return doc.data().saldo || 0;
    else return 0;
  }

  // Atualiza interface saldo
  function mostrarSaldo(valor) {
    userSaldoSpan.textContent = valor.toFixed(2).replace('.', ',');
  }

  // Limpa mensagens
  function clearMessages() {
    authMessage.textContent = "";
    actionMessage.textContent = "";
    actionMessage.className = "";
  }

  // Exibe mensagem de erro ou sucesso
  function showMessage(msg, isError = false) {
    actionMessage.textContent = msg;
    actionMessage.className = isError ? "message error" : "message";
  }

  // Login
  btnLogin.onclick = async () => {
    clearMessages();
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      authMessage.textContent = "Email e senha são obrigatórios.";
      return;
    }
    try {
      const userCredential = await auth.signInWithEmailAndPassword(email, password);
      const user = userCredential.user;
      await createUserDoc(user.uid, user.email);
      setupUser(user);
    } catch (e) {
      authMessage.textContent = "Erro no login: " + e.message;
    }
  };

  // Registro
  btnRegister.onclick = async () => {
    clearMessages();
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      authMessage.textContent = "Email e senha são obrigatórios.";
      return;
    }
    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const user = userCredential.user;
      await createUserDoc(user.uid, user.email);
      setupUser(user);
    } catch (e) {
      authMessage.textContent = "Erro no registro: " + e.message;
    }
  };

  // Logout
  btnLogout.onclick = () => {
    auth.signOut();
  };

  // Atualiza UI após login
  async function setupUser(user) {
    authArea.style.display = "none";
    userArea.style.display = "block";
    userEmailSpan.textContent = user.email;
    const saldo = await getSaldo(user.uid);
    mostrarSaldo(saldo);
    clearMessages();
    qrCodeCanvas.getContext('2d').clearRect(0, 0, qrCodeCanvas.width, qrCodeCanvas.height);
    infoPix.textContent = "";
  }

  // Detecta usuário logado no load da página
  auth.onAuthStateChanged(user => {
    if (user) {
      setupUser(user);
    } else {
      authArea.style.display = "block";
      userArea.style.display = "none";
      emailInput.value = "";
      passwordInput.value = "";
      clearMessages();
      qrCodeCanvas.getContext('2d').clearRect(0, 0, qrCodeCanvas.width, qrCodeCanvas.height);
      infoPix.textContent = "";
    }
  });

  // Botão gerar Pix + taxa 5%
  btnGeneratePix.onclick = async () => {
    clearMessages();
    const val = parseFloat(paymentAmountInput.value);
    if (isNaN(val) || val <= 0) {
      showMessage("Digite um valor válido maior que zero.", true);
      return;
    }
    const user = auth.currentUser;
    if (!user) {
      showMessage("Usuário não autenticado.", true);
      return;
    }

    // Valor total com taxa
    const valorTotal = val * 1.05;
    const valorStr = formatBRLtoPix(valorTotal);

    // ID de transação única
    const txid = "LAN-" + Date.now();

    // Gera payload Pix
    const pixPayload = generatePixPayload(pixKeyFundo, valorStr, txid);

    // Limpa canvas
    const ctx = qrCodeCanvas.getContext('2d');
    qrCodeCanvas.width = 220;
    qrCodeCanvas.height = 220;
    ctx.clearRect(0, 0, 220, 220);

    // Gera QR Code
    QRCode.toCanvas(qrCodeCanvas, pixPayload, { width: 220 }, (err) => {
      if (err) {
        showMessage("Erro ao gerar QR Code: " + err, true);
        return;
      }
    });

    infoPix.textContent = `Chave Pix (fundo): ${pixKeyFundo} | Valor total: R$ ${valorTotal.toFixed(2).replace('.', ',')} (com 5% taxa)`;

    // Atualiza saldo do usuário (incrementa valor pago - sem taxa separada)
    try {
      await updateSaldo(user.uid, val);
      const novoSaldo = await getSaldo(user.uid);
      mostrarSaldo(novoSaldo);
      showMessage("Pagamento registrado! Saldo atualizado.");
      paymentAmountInput.value = "";
    } catch (e) {
      showMessage("Erro ao atualizar saldo: " + e, true);
    }
  };

  // Botão saque
  btnWithdraw.onclick = async () => {
    clearMessages();
    const val = parseFloat(withdrawAmountInput.value);
    if (isNaN(val) || val <= 0) {
      showMessage("Digite um valor válido para saque.", true);
      return;
    }
    const user = auth.currentUser;
    if (!user) {
      showMessage("Usuário não autenticado.", true);
      return;
    }
    try {
      const saldoAtual = await getSaldo(user.uid);
      if (val > saldoAtual) {
        showMessage("Saldo insuficiente para saque.", true);
        return;
      }

      // Remove do saldo do usuário
      await updateSaldo(user.uid, -val);

      // Aqui você pode registrar a solicitação de saque no Firestore (opcional)
      // Ou enviar notificação para liberar o saque na conta do fundo

      const novoSaldo = await getSaldo(user.uid);
      mostrarSaldo(novoSaldo);
      showMessage(`Saque de R$ ${val.toFixed(2).replace('.', ',')} solicitado com sucesso!`);

      withdrawAmountInput.value = "";
    } catch (e) {
      showMessage("Erro ao processar saque: " + e, true);
    }
  };

</script>
</body>
</html>
