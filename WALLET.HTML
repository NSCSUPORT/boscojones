<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JBX1000 - Pix Oficial com CRC-16</title>
  <link rel="icon" href="logo.ico" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: #0d1117; color: #e0e0e0;
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0 8px;
      display: flex; justify-content: center; min-height: 100vh; align-items: flex-start; padding-top: 20px;
      font-size: 14px;
    }
    .container {
      width: 100%; max-width: 400px;
      background: #1c1f26; border-radius: 12px; padding: 18px; box-shadow: 0 0 10px #000a;
    }
    h1 {
      text-align: center; margin-bottom: 16px; color: #00ffb2;
      font-weight: 700; font-size: 1.3rem;
    }
    label {
      display: block; margin: 10px 0 5px; font-weight: 700; font-size: 0.9rem;
    }
    input[type="number"] {
      width: 100%; padding: 8px; border: 1px solid #444;
      border-radius: 6px; background-color: #0f141a; color: #fff;
      font-size: 0.9rem;
    }
    .btn {
      width: 48%; padding: 10px; margin-top: 12px;
      border: none; border-radius: 8px; font-weight: 700;
      cursor: pointer; transition: background 0.3s; font-size: 0.9rem;
    }
    #btn-deposit { background-color: #28a745; color: white; }
    #btn-deposit:hover { background-color: #218838; }
    #btn-withdraw { background-color: #dc3545; color: white; float: right; }
    #btn-withdraw:hover { background-color: #c82333; }
    #btn-generate-pix {
      width: 100%; margin-top: 18px; padding: 12px;
      background-color: #007bff; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
      font-size: 1rem;
    }
    #btn-generate-pix:hover { background-color: #0056b3; }
    #btn-clear-history {
      width: 100%; margin-top: 14px; padding: 8px;
      background-color: #666; border: none; border-radius: 8px;
      color: white; cursor: pointer; font-weight: 700;
      font-size: 0.9rem;
    }
    #btn-clear-history:hover { background-color: #444; }
    #saldo-container {
      text-align: center; margin-top: 18px;
      font-size: 1rem; color: #1efcb8; font-weight: 700;
    }
    #qrcode-container {
      margin-top: 18px; padding: 14px; background-color: #11161c;
      border-radius: 10px; text-align: center; min-height: 220px;
    }
    pre {
      background: #000000cc; padding: 8px; margin-top: 8px; border-radius: 6px;
      color: #ffffffcc; font-size: 0.85rem; user-select: all; white-space: pre-wrap; word-break: break-word;
      max-height: 100px; overflow-y: auto;
    }
    #history-container {
      margin-top: 28px; max-height: 220px; overflow-y: auto;
      background: #10131a; border-radius: 10px; padding: 12px; font-size: 0.85rem;
    }
    #history-container h2 {
      margin-top: 0; font-weight: 700; color: #0ff; text-align: center; margin-bottom: 8px;
      font-size: 1rem;
    }
    .transaction {
      padding: 4px 6px; border-bottom: 1px solid #222;
      display: flex; justify-content: space-between; align-items: center;
    }
    .transaction:last-child { border-bottom: none; }
    .transaction .type { font-weight: 700; text-transform: capitalize; font-size: 0.85rem; }
    .transaction.deposit { color: #28a745; }
    .transaction.withdraw { color: #dc3545; }
    .transaction.pix { color: #007bff; }
    .transaction .date { font-size: 0.7rem; color: #aaa; font-style: italic; }
    @media (max-width: 420px) {
      .btn { width: 100%; margin-top: 8px; float: none; }
      #btn-withdraw { float: none; }
      #btn-generate-pix { font-size: 0.95rem; }
      h1 { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Carteira JBX1000 - Pix Oficial com CRC</h1>

    <label for="valor">Valor (R$):</label>
    <input type="number" id="valor" placeholder="0,00" min="1" step="0.01" />

    <button id="btn-deposit" class="btn">Depositar</button>
    <button id="btn-withdraw" class="btn">Sacar</button>

    <button id="btn-generate-pix">Gerar Pix Copia e Cola (5% taxa)</button>

    <div id="saldo-container">Saldo: <span id="saldo">R$ 0,00</span></div>

    <div id="qrcode-container">
      <span>QR Code e Copia e Cola aparecerão aqui</span>
    </div>

    <button id="btn-clear-history">Limpar Histórico</button>

    <div id="history-container">
      <h2>Histórico de Transações</h2>
      <div id="history-list">Nenhuma transação registrada.</div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  const STORAGE_SALDO_KEY = "jbx1000_wallet_saldo";
  const STORAGE_HISTORY_KEY = "jbx1000_wallet_historico";

  let saldoAtual = parseFloat(localStorage.getItem(STORAGE_SALDO_KEY)) || 0;
  let historico = JSON.parse(localStorage.getItem(STORAGE_HISTORY_KEY)) || [];

  const formatarReal = valor => valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });

  function atualizarSaldoNaTela() {
    document.getElementById("saldo").innerText = formatarReal(saldoAtual);
  }

  function validarValor() {
    const valorInput = document.getElementById("valor").value.replace(',', '.');
    const valor = parseFloat(valorInput);
    if (isNaN(valor) || valor <= 0) {
      alert("Digite um valor válido maior que 0.");
      return null;
    }
    return valor;
  }

  function limparInput() {
    document.getElementById("valor").value = '';
  }

  function limparQRCode() {
    document.getElementById("qrcode-container").innerHTML = `<span>QR Code e Copia e Cola aparecerão aqui</span>`;
  }

  function adicionarHistorico(tipo, valor) {
    const dataAtual = new Date();
    historico.unshift({
      tipo,
      valor,
      data: dataAtual.toISOString()
    });
    if (historico.length > 100) historico.pop();
    localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(historico));
    renderizarHistorico();
  }

  function renderizarHistorico() {
    const historyList = document.getElementById("history-list");
    if (!historico.length) {
      historyList.innerHTML = "Nenhuma transação registrada.";
      return;
    }
    historyList.innerHTML = "";
    historico.forEach(tx => {
      const div = document.createElement("div");
      div.className = `transaction ${tx.tipo === "depósito" ? "deposit" : tx.tipo === "saque" ? "withdraw" : "pix"}`;
      const date = new Date(tx.data);
      div.innerHTML = `
        <span class="type">${tx.tipo}</span> - 
        <span class="value">${formatarReal(tx.valor)}</span>
        <span class="date">(${date.toLocaleString("pt-BR")})</span>
      `;
      historyList.appendChild(div);
    });
  }

  function aplicarGeminiosidade(valor) {
    return valor * 89;
  }

  // Função para calcular o CRC16 CCITT (0xFFFF init) usado no Pix
  function crc16(payload) {
    let crc = 0xFFFF;
    for (let i = 0; i < payload.length; i++) {
      crc ^= payload.charCodeAt(i) << 8;
      for (let j = 0; j < 8; j++) {
        if ((crc & 0x8000) !== 0) {
          crc = (crc << 1) ^ 0x1021;
        } else {
          crc <<= 1;
        }
        crc &= 0xFFFF; // garante 16 bits
      }
    }
    return crc.toString(16).toUpperCase().padStart(4, '0');
  }

  function montarCampo(id, valor) {
    const tamanho = valor.length.toString().padStart(2, '0');
    return `${id}${tamanho}${valor}`;
  }

  // Função para montar o campo PIX no padrão oficial
  function montarPayloadPix({chave, nome, cidade, valor, txid}) {
    let payload = '';
    payload += montarCampo('00', '01'); // Payload Format Indicator
    payload += montarCampo('26', montarCampo('00', 'BR.GOV.BCB.PIX') + montarCampo('01', chave)); // Merchant Account Information
    payload += montarCampo('52', '0000'); // Merchant Category Code
    payload += montarCampo('53', '986'); // Currency BRL
    if (valor) {
      const valorFixado = Number(valor).toFixed(2);
      payload += montarCampo('54', valorFixado); // Amount
    }
    payload += montarCampo('58', 'BR'); // Country Code
    payload += montarCampo('59', nome.substring(0, 25)); // Merchant Name max 25 chars
    payload += montarCampo('60', cidade.substring(0, 15)); // Merchant City max 15 chars
    if (txid) {
      payload += montarCampo('62', montarCampo('05', txid)); // Additional Data Field Template - TXID
    }
    payload += '6304'; // CRC16 placeholder

    const crc = crc16(payload);
    return payload + crc;
  }

  document.getElementById("btn-deposit").onclick = () => {
    const valor = validarValor();
    if (valor === null) return;

    const creditado = aplicarGeminiosidade(valor);
    saldoAtual += creditado;
    localStorage.setItem(STORAGE_SALDO_KEY, saldoAtual.toFixed(2));

    adicionarHistorico("depósito", creditado);
    atualizarSaldoNaTela();
    alert(`Depósito realizado com Geminiosidade (x89)\nValor creditado: ${formatarReal(creditado)}`);
    limparInput();
    limparQRCode();
  };

  document.getElementById("btn-withdraw").onclick = () => {
    const valor = validarValor();
    if (valor === null) return;

    if (valor > saldoAtual) {
      alert("Saldo insuficiente.");
      return;
    }

    saldoAtual -= valor;
    localStorage.setItem(STORAGE_SALDO_KEY, saldoAtual.toFixed(2));
    adicionarHistorico("saque", valor);
    atualizarSaldoNaTela();
    alert(`Saque realizado: ${formatarReal(valor)}`);
    limparInput();
    limparQRCode();
  };

  document.getElementById("btn-generate-pix").onclick = () => {
    const valor = validarValor();
    if (valor === null) return;

    const chavePix = "48761013889";
    const nome = "JBX1000 Wallet";
    const cidade = "SAO PAULO";
    const txid = "TXID123";

    const taxa = 1.05;
    const valorComTaxa = (valor * taxa).toFixed(2);

    const payload = montarPayloadPix({
      chave: chavePix,
      nome,
      cidade,
      valor: valorComTaxa,
      txid
    });

    const container = document.getElementById("qrcode-container");
    container.innerHTML = "";

    QRCode.toCanvas(payload, { width: 180 }, (err, canvas) => {
      if (err) {
        alert("Erro ao gerar QR Code");
        limparQRCode();
        return;
      }
      container.appendChild(canvas);
      const pre = document.createElement("pre");
      pre.innerText = payload;
      container.appendChild(pre);
    });

    const creditado = aplicarGeminiosidade(valor);
    saldoAtual += creditado;
    localStorage.setItem(STORAGE_SALDO_KEY, saldoAtual.toFixed(2));

    adicionarHistorico("pix", creditado);
    atualizarSaldoNaTela();
    alert(`Pix gerado com Geminiosidade x89\nValor creditado: ${formatarReal(creditado)}`);
    limparInput();
  };

  document.getElementById("btn-clear-history").onclick = () => {
    if (confirm("Tem certeza que deseja limpar o histórico de transações?")) {
      historico = [];
      localStorage.setItem(STORAGE_HISTORY_KEY, JSON.stringify(historico));
      renderizarHistorico();
    }
  };

  // Inicialização
  atualizarSaldoNaTela();
  limparQRCode();
  renderizarHistorico();
</script>

</body>
</html>
